name: Azure ML Workflow - Plant Disease

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_training:
        description: 'Skip Azure ML training (download model only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_deployment:
        description: 'Skip Kubernetes deployment'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
          - 'true'

env:
  # Azure Configuration - Set these in GitHub Repository Variables
  GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  WORKSPACE: ${{ vars.AZURE_WORKSPACE_NAME }}
  LOCATION: ${{ vars.AZURE_LOCATION }}
  COMPUTE_NAME: ${{ vars.AZURE_COMPUTE_NAME }}
  COMPUTE_SIZE: ${{ vars.AZURE_COMPUTE_SIZE || 'Standard_DS2_v2' }}
  MODEL_NAME: ${{ vars.MODEL_NAME || 'plant-disease-classifier-model' }}

jobs:
  azure-pipeline:
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_training != 'true' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true

      - name: Validate Required Variables
        run: |
          echo "Checking required GitHub Variables..."
          MISSING_VARS=""
          
          if [ -z "${{ vars.AZURE_RESOURCE_GROUP }}" ]; then
            MISSING_VARS="$MISSING_VARS AZURE_RESOURCE_GROUP"
          fi
          if [ -z "${{ vars.AZURE_WORKSPACE_NAME }}" ]; then
            MISSING_VARS="$MISSING_VARS AZURE_WORKSPACE_NAME"
          fi
          if [ -z "${{ vars.AZURE_LOCATION }}" ]; then
            MISSING_VARS="$MISSING_VARS AZURE_LOCATION"
          fi
          if [ -z "${{ vars.AZURE_COMPUTE_NAME }}" ]; then
            MISSING_VARS="$MISSING_VARS AZURE_COMPUTE_NAME"
          fi
          
          if [ ! -z "$MISSING_VARS" ]; then
            echo "‚ùå ERROR: Missing required GitHub Variables:$MISSING_VARS"
            echo ""
            echo "Please set these variables in your repository:"
            echo "https://github.com/${{ github.repository }}/settings/variables/actions"
            echo ""
            echo "Required variables:"
            echo "  - AZURE_RESOURCE_GROUP = rg-nathan-mpops"
            echo "  - AZURE_WORKSPACE_NAME = danylo-bordunov-mlops-project"
            echo "  - AZURE_LOCATION = germanywestcentral"
            echo "  - AZURE_COMPUTE_NAME = danylo-compute"
            exit 1
          fi
          
          echo "‚úÖ All required variables are set:"
          echo "  GROUP: $GROUP"
          echo "  WORKSPACE: $WORKSPACE"
          echo "  LOCATION: $LOCATION"
          echo "  COMPUTE_NAME: $COMPUTE_NAME"
          echo "  COMPUTE_SIZE: $COMPUTE_SIZE"
          echo "  MODEL_NAME: $MODEL_NAME"

      - name: Azure Login
        uses: Azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription and Extensions
        run: |
          # Strip whitespace from all variables (fix potential newline issues)
          export GROUP=$(echo "$GROUP" | tr -d '\n\r' | xargs)
          export WORKSPACE=$(echo "$WORKSPACE" | tr -d '\n\r' | xargs)
          export LOCATION=$(echo "$LOCATION" | tr -d '\n\r' | xargs)
          export COMPUTE_NAME=$(echo "$COMPUTE_NAME" | tr -d '\n\r' | xargs)
          
          echo "Cleaned variables:"
          echo "  GROUP: '$GROUP'"
          echo "  WORKSPACE: '$WORKSPACE'"
          echo "  LOCATION: '$LOCATION'"
          echo "  COMPUTE_NAME: '$COMPUTE_NAME'"
          
          # Add ML extension first to avoid warnings
          az extension add --name ml -y 2>/dev/null || echo "ML extension already installed"
          
          # Extract subscription ID from AZURE_CREDENTIALS and set it explicitly
          SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
          echo "Setting subscription to: $SUBSCRIPTION_ID"
          az account set --subscription $SUBSCRIPTION_ID
          az account show
          
          # Set default workspace context with cleaned variables
          az configure --defaults group="$GROUP" workspace="$WORKSPACE" location="$LOCATION"
          
          # Verify workspace exists (don't create, just verify)
          echo "Verifying workspace '$WORKSPACE' exists in resource group '$GROUP'..."
          az ml workspace show -n "$WORKSPACE" -g "$GROUP" || {
            echo "‚ùå ERROR: Workspace '$WORKSPACE' not found!"
            echo "Please create the workspace first via Azure Portal or Azure CLI"
            exit 1
          }
          echo "‚úÖ Workspace verified successfully"

      # CREATE COMPUTE (only if doesn't exist)
      - name: Azure -- Create compute
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            # Check if compute exists
            if az ml compute show --name $COMPUTE_NAME 2>/dev/null; then
              echo "Compute '$COMPUTE_NAME' already exists. Skipping creation."
            else
              echo "Compute '$COMPUTE_NAME' not found. Creating..."
              
              # Create compute instance
              az ml compute create \
                --name $COMPUTE_NAME \
                --type ComputeInstance \
                --size $COMPUTE_SIZE
            fi

      # START COMPUTE
      - name: Azure -- Check and Start Compute
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            # Get compute state
            STATE=$(az ml compute show --name $COMPUTE_NAME --query "state" -o tsv 2>/dev/null || echo "Unknown")
            
            # Only start if stopped
            if [ "$STATE" = "Stopped" ]; then
              echo "Starting compute..."
              az ml compute start --name $COMPUTE_NAME
            else
              echo "Compute is already in state: $STATE. Skipping start."
            fi

      # ENVIRONMENT SETUP
      - name: Azure -- Environment Setup
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            # Check if environment folder exists
            if [ -d "./environment" ]; then
              # Register only environment.yaml, not conda.yaml
              if [ -f "./environment/environment.yaml" ]; then
                echo "Creating environment from: ./environment/environment.yaml"
                az ml environment create --file "./environment/environment.yaml" || echo "Environment might already exist, continuing..."
              fi
            else
              echo "No ./environment folder found. Skipping environment setup."
            fi

      # COMPONENT SETUP
      - name: Azure -- Component Setup
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            echo "Registering components..."
            
            # Data Prep Component - run from component directory
            if [ -f "./components/data_prep/data_prep.yaml" ]; then
              echo "Creating data_prep component..."
              (cd ./components/data_prep && az ml component create --file data_prep.yaml) || echo "‚ö†Ô∏è Failed to create data_prep"
            fi
            
            # Data Split Component - run from component directory
            if [ -f "./components/data_split/data_split.yaml" ]; then
              echo "Creating data_split component..."
              (cd ./components/data_split && az ml component create --file data_split.yaml) || echo "‚ö†Ô∏è Failed to create data_split"
            fi
            
            # Training Component - run from component directory
            if [ -f "./components/training/training.yaml" ]; then
              echo "Creating training component..."
              (cd ./components/training && az ml component create --file training.yaml) || echo "‚ö†Ô∏è Failed to create training"
            fi
            
            echo "Component registration complete."

      # RUN PIPELINE
      - name: Azure -- Pipeline Run
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            # Run the pipeline with dynamic compute name and version tagging
            az ml job create --file ./pipelines/plant-disease-classification.yaml --stream \
              --set settings.default_compute=azureml:$COMPUTE_NAME \
              --set name=plant-disease-${{ github.sha }}-${{ github.run_id }} \
              --set tags.github_sha=${{ github.sha }} \
              --set tags.github_ref=${{ github.ref }}

      # CLEANUP - STOP COMPUTE
      - name: Azure -- Stop Compute
        uses: Azure/CLI@v2.2.0
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az ml compute stop --name $COMPUTE_NAME
        continue-on-error: true

      - name: Azure Logout
        run: |
          az logout
        if: always()

  download: 
    needs: azure-pipeline
    runs-on: ubuntu-24.04
    if: ${{ always() }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          clean: true
      
      - name: Azure Login
        uses: Azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure -- Download Model
        uses: Azure/CLI@v2.2.0 
        with:
          azcliversion: 2.79.0
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
            VERSION=$(az ml model list -n $MODEL_NAME --query "[0].version" -o tsv)
            az ml model download -n $MODEL_NAME -v $VERSION --download-path ./artifact-model
      
      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4.3.3
        with:
          name: trained-model
          path: artifact-model
    
      - name: Docker -- Upload API code from Inference
        uses: actions/upload-artifact@v4.3.3
        with:
          name: docker-config
          path: inference

  deploy:
    needs: download
    runs-on: self-hosted
    if: ${{ inputs.skip_deployment != 'true' }}
    permissions:
      contents: read
      packages: write
    env:
      KUBECONFIG: /Users/danyukezz/.kube/config
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 0

      # DOCKER - Gather Tags
      - name: Docker -- Gather Tags
        id: docker-meta-data
        uses: docker/metadata-action@v5.5.1
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/plant-disease-api
          tags: |
            type=raw,value=latest
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      # DOCKER - Login to GHCR
      - name: Docker -- Login to GHCR
        uses: docker/login-action@v3.2.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # DOCKER - Download API Code
      - name: Docker -- Download API Code for Inference
        uses: actions/download-artifact@v4.1.7
        with:
          name: docker-config
          path: inference

      # DOCKER - Download Model
      - name: Docker -- Download Trained Model
        uses: actions/download-artifact@v4.1.7
        with:
          name: trained-model
          path: inference/model

      # DOCKER - Build and Push
      - name: Docker Build and push
        id: docker_build
        uses: docker/build-push-action@v5.3.0
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta-data.outputs.tags }}

      # KUBERNETES - Setup kubectl config
      - name: Kubernetes -- Setup Config
        run: |
          echo "HOME: $HOME"
          echo "USER: $USER"
          ls -la ~/.kube/config || echo "Kubeconfig not found at ~/.kube/config"
          kubectl cluster-info || echo "‚ö†Ô∏è Kubectl not configured"
          kubectl version --client
      
      # KUBERNETES - Create/Update Image Pull Secret
      - name: Kubernetes -- Update Image Pull Secret
        run: |
          kubectl delete secret ghcr-secret --ignore-not-found=true
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.repository_owner }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --docker-email=${{ github.actor }}@users.noreply.github.com
          echo "‚úÖ Image pull secret updated"
      
      # KUBERNETES - Deploy Application
      - name: Kubernetes -- Deploy to Cluster
        env:
          CONTAINER_IMAGE: ghcr.io/${{ github.repository_owner }}/plant-disease-api:latest
        run: |
          echo "üöÄ Deploying Plant Disease API"
          echo "üì¶ GitHub SHA: ${{ github.sha }}"
          echo "üìã GitHub Ref: ${{ github.ref }}"
          echo "üîó Run ID: ${{ github.run_id }}"
          echo "üê≥ Container Image: $CONTAINER_IMAGE"
          
          # Substitute environment variables in k8s files
          envsubst < k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml
          
          kubectl rollout status deployment/plant-disease-api --timeout=5m
          
          kubectl get deployments
          kubectl get services
          kubectl get pods
          
          echo "‚úÖ Deployment complete! Model version tagged with SHA: ${{ github.sha }}"
